<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/icons/favicon.ico') }}">
    <title>InspekApp - Nova Inspeção</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 

    <!-- Corte de imagens -->   
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root {
            --primary-color: #6C63FF;
            --primary-dark: #564FD9;
            --secondary-color: #FF6584;
            --dark-bg: #1A1A2E;
            --darker-bg: #16213E;
            --card-bg: #242445;
            --text-light: #F1F1F1;
            --text-muted: #B8B8B8;
            --success-color: #4BB543;
            --warning-color: #FFA500;
            --danger-color: #FF5252;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        /* Estilo para a célula de pendências */
        .pendencia-cell {
            text-align: center;
            font-size: 1.2em;
            position: relative;
        }

        .pendencia-cell:hover::after {
            content: attr(title);
            position: absolute;
            background: var(--darker-bg);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--primary-color);
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            z-index: 1000;
        }
        .loading-message, .no-checklist {
            padding: 1rem;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .obrigatorio-icon {
            color: var(--danger-color);
            margin-right: 5px;
        }
        .checkbox-group {
            margin-top: 1rem;
        }

        .custom-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.95rem;
            user-select: none;
            position: relative;
            padding-left: 30px;
            color: var(--text-light);
        }

        .custom-checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .custom-checkbox .checkmark {
            position: absolute;
            left: 0;
            top: 0;
            height: 20px;
            width: 20px;
            background-color: #eee;
            border-radius: 4px;
            border: 2px solid #ccc;
            transition: all 0.3s ease;
        }

        .custom-checkbox input:checked ~ .checkmark {
            background-color: var(--primary);
            border-color: var(--primary-dark);
        }

        .custom-checkbox .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .custom-checkbox input:checked ~ .checkmark:after {
            display: block;
        }

        .custom-checkbox .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }        
        /* Adicione ao CSS existente */
        #location-status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #location-status i {
            font-size: 1.2rem;
        }
        .inspection-item.obrigatorio {
            border-left: 3px solid var(--danger-color);
        }        
        /* Sweet Alert Style Modals */
        .swal-modal {
            background-color: var(--darker-bg);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .swal-title {
            color: var(--text-light);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .swal-text {
            color: var(--text-muted);
            font-size: 1rem;
            text-align: center;
        }

        .swal-icon {
            margin: 1.5rem auto;
        }

        .swal-icon--success::before, 
        .swal-icon--success::after {
            background: var(--darker-bg);
        }

        .swal-icon--success__hide-corners {
            background-color: transparent;
        }

        .swal-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.75rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: var(--transition);
        }

        .swal-button:not([disabled]):hover {
            background-color: var(--primary-dark);
        }

        .swal-button--confirm {
            background-color: var(--primary-color);
        }

        .swal-button--cancel {
            background-color: var(--danger-color);
        }

        .swal-footer {
            text-align: center;
            margin-top: 1.5rem;
        }
        .swal2-container {
            z-index: 99999 !important;
        }
        #crop-container {
            max-width: 100%;
            width: 100%;
            max-height: 400px;
            overflow: hidden;
            margin: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #222;
            padding: 10px;
            border-radius: 12px;
        }

        #crop-image {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }
            
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .select-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }
        /* Top Navigation Bar */
        .top-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            flex-direction: row-reverse;
        }

        .top-bar .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .nav-button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-button i {
            font-size: 1.1rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            transition: var(--transition);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .user-name {
            font-weight: 500;
        }

        /* Main Container */
        .main-container {
            flex: 1;
            padding: 6rem 2rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .form-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .form-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .form-title {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }


        .form-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Flash Messages */
        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideDown 0.4s ease-out;
        }

        .alert i {
            font-size: 1.25rem;
        }

        .alert-success {
            background-color: rgba(75, 181, 67, 0.2);
            border-left: 4px solid var(--success-color);
            color: var(--success-color);
        }

        .alert-error {
            background-color: rgba(255, 82, 82, 0.2);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-color);
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-label span {
            color: var(--secondary-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1.25rem;
            background: #242445;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.3);
        }

        .form-control[readonly] {
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
        }

        .input-group {
            position: relative;
            display: flex;
        }

        .input-group .form-control {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .input-group-append {
            display: flex;
        }

        .input-group-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0 1.25rem;
            border-top-right-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .input-group-btn:hover {
            background: var(--primary-dark);
        }

        /* Inspection Items */
        .inspection-section {
            margin: 2rem 0;
        }

        .section-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--text-light);
            position: relative;
            padding-left: 1.5rem;
        }

        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        /* Estilo base do item */ 
        .inspection-item {
            background-color: var(--card-bg);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 14px 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex: 1 1 200px;
            min-width: 150px;
            max-width: 300px;
            text-align: center;
            margin: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            user-select: none;
        }

        /* Estilo quando marcado */
        .inspection-item.checked {
            background-color: #4BB543;
            color: white;
            border-color: #3a9a34;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Ícone de check - escondido por padrão */
        .check-icon {
            display: none;
            position: absolute;
            top: 8px;
            right: 10px;
            color: white;
            font-size: 1rem;
        }

        /* Mostra o ícone quando o item está marcado */
        .inspection-item.checked .check-icon {
            display: block;
        }

        /* Ícone de obrigatório */
        .obrigatorio-icon {
            color: var(--danger-color);
            margin-right: 5px;
        }

        /* Estilo para itens obrigatórios */
        .inspection-item[data-obrigatorio="true"] {
            border-left: 4px solid var(--danger-color);
        }

        /* Feedback visual para itens obrigatórios marcados */
        .inspection-item[data-obrigatorio="true"].checked {
            border-left: 4px solid var(--success-color);
        }

        /* Efeito hover */
        .inspection-item:hover {
            background-color: rgba(108, 99, 255, 0.1);
        }

        .inspection-item.checked:hover {
            background-color: #3a9a34;
        }
        /* File Upload */
        .file-upload {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .file-upload-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: var(--primary-color);
            background: rgba(108, 99, 255, 0.05);
        }

        .file-upload-label i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .file-upload-text {
            font-size: 0.9rem;
        }

        .file-upload-text strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .file-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
        }

        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-preview-item-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
        }

        /* Submit Button */
        .submit-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 2rem auto 0;
            width: 100%;
            max-width: 300px;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 99, 255, 0.4);
        }

        .submit-btn:active {
            transform: translateY(1px);
        }

        /* Modal Moderno */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1200;
            animation: fadeIn 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            overflow-y: auto;
            padding: 1rem;
        }

        .modal-content {
            background-color: var(--darker-bg);
            margin: 5vh auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            box-shadow: var(--box-shadow);
            position: relative;
            animation: slideDown 0.4s;
            border: var(--glass-border);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .close {
            position: absolute;
            right: 1.5rem;
            top: 1rem;
            font-size: 1.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            background: rgba(255, 101, 132, 0.1);
            color: var(--secondary-color);
            transform: rotate(90deg);
        }

        .profile-pic-container {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
        }

        #modal-profile-pic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        #modal-profile-pic:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 5px rgba(108, 99, 255, 0.3);
        }

        #change-profile-pic {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--text-light);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            margin-top: 1rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        #change-profile-pic:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .user-details {
            margin-top: 1.5rem;
            background: rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            border-radius: var(--border-radius-sm);
        }

        .user-details p {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }

        .user-details strong {
            color: var(--primary-light);
            font-weight: 500;
        }

        .user-details span {
            text-align: right;
            color: var(--text-light);
        }
        .badge-primary {
            background: rgba(108, 99, 255, 0.2);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--secondary-color);
            transform: rotate(90deg);
        }

        .modal-search {
            width: 100%;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .modal-table th {
            background: rgba(108, 99, 255, 0.1);
            color: var(--primary-color);
            padding: 0.75rem;
            text-align: left;
            font-weight: 500;
        }

        .modal-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-light);
        }

        .modal-table tr:last-child td {
            border-bottom: none;
        }

        .modal-table tr:hover td {
            background: rgba(108, 99, 255, 0.05);
        }

        .select-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .select-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* QR Scanner */
        .scanner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .scanner-video {
            width: 100%;
            max-width: 500px;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .scanner-message {
            color: white;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Loading Indicator */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(108, 99, 255, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }

        .inspection-item.obrigatorio:not(.checked) {
            animation: pulse 2s infinite;
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .main-container {
                padding: 5rem 1rem 1rem;
            }

            .form-card {
                padding: 1.5rem;
            }

            .form-title {
                font-size: 1.8rem;
            }

            .inspection-items {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }

            .modal-table {
                display: block;
                overflow-x: auto;
            }

            .top-bar {
                padding: 0.75rem 1rem;
            }

            .nav-button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .user-name {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .inspection-items {
                grid-template-columns: 1fr 1fr;
            }

            .submit-btn {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <header class="top-bar">
        <div class="nav-buttons">
            <button class="nav-button" onclick="window.location.href='/'">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button class="nav-button" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
        
        <div class="user-profile" onclick="toggleModal()">
            <img class="user-avatar" id="user-profile-pic" 
                 src="{{ url_for('static', filename=current_user.foto_perfil) if current_user.foto_perfil else 'https://cdn-icons-png.flaticon.com/128/1077/1077012.png' }}" 
                 alt="Foto de Perfil">
            <span class="user-name" id="userName">{{ current_user.primeiro_nome }} {{ current_user.sobrenome }}</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <div class="form-card">
            <div class="form-header">
                <h1 class="form-title">InspekApp - Inspeção de Equipamentos</h1>
                <p class="form-subtitle">Registro de inspeção de equipamentos</p>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" id="inspecaoForm" enctype="multipart/form-data">
                <input type="hidden" name="equipamento_id" id="equipamento_id">
                <input type="hidden" name="numero_inspecao" id="numero_inspecao">
                <input type="hidden" name="status_inspecao" id="status_inspecao" value="Pendente">
                <input type="hidden" name="motivo" id="motivo" value="">
                <input type="hidden" name="tipo_equipamento_id" id="tipo_equipamento_id">
        
                <div class="form-grid">
                    <!-- Equipment Information -->
                    <div class="form-group">
                        <label for="equipamento_codigo_barras">Equipamento <span>*</span></label>
                        <div class="input-group">
                            <input type="text" id="equipamento_codigo_barras" name="equipamento_codigo_barras" 
                                   class="form-control" placeholder="Selecione ou escaneie o equipamento" 
                                    readonly onclick="abrirModalEquipamento()">
                            <div class="input-group-append">
                                <button type="button" class="input-group-btn" onclick="abrirLeitorQRCode()">
                                    <i class="fas fa-barcode"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tipo_equipamento">Tipo do Equipamento <span>*</span></label>
                        <input type="text" id="tipo_equipamento" name="tipo_equipamento" 
                               class="form-control" placeholder="Tipo do equipamento" required readonly>
                    </div>

                    <div class="form-group" id="classe_equipamento_group" style="display: none;">
                        <label for="classe_equipamento">Classe do Extintor</label>
                        <input type="text" id="classe_equipamento" name="classe_equipamento" 
                               class="form-control" placeholder="Classe do extintor" readonly>
                    </div>

                    <div class="form-group">
                        <label for="localizacao_equipamento">Localização <span>*</span></label>
                        <input type="text" id="localizacao_equipamento" name="localizacao_equipamento" 
                               class="form-control" placeholder="Localização do equipamento" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="status_equipamento">Status <span>*</span></label>
                        <input type="text" id="status_equipamento" name="status_equipamento" 
                               class="form-control" placeholder="Status do equipamento" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="responsavel">Responsável <span>*</span></label>
                        <div class="input-group">
                            <input type="text" id="responsavel" name="responsavel" class="form-control" 
                                   value="{{ current_user.nome }}" placeholder="Responsável pela inspeção" 
                                   required readonly {% if current_user.nivel_acesso in ['Administrador'] %} onclick="abrirModalResponsavel()" {% endif %}>
                            {% if current_user.nivel_acesso in ['Administrador'] %}
                            <div class="input-group-append">
                                <button type="button" class="input-group-btn" onclick="abrirModalResponsavel()">
                                    <i class="fas fa-user-tie"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Inspection Items Section -->
                <div class="inspection-section">
                    <h3 class="section-title">Itens da Inspeção</h3>
                    <div id="checklist-container">
                        <!-- Os itens do checklist serão renderizados aqui dinamicamente -->
                    </div>
                </div>

                <!-- Observations Section -->
                <div class="form-group">
                    <label for="observacoes">Observações</label>
                    <textarea id="observacoes" name="observacoes" class="form-control" rows="4" 
                              placeholder="Adicione quaisquer observações relevantes..."></textarea>
                </div>

                <div class="form-group checkbox-group">
                    <label class="custom-checkbox">
                        <input type="checkbox" id="compartilharLocalizacao" name="compartilharLocalizacao">
                        <span class="checkmark"></span>
                        Compartilhar minha localização durante a inspeção
                    </label>
                </div>

                <!-- Photos Section -->
                <div class="form-group">
                    <label for="fotos">Fotos da Inspeção <span>*</span></label>
                    <div class="file-upload">
                        <input type="file" id="fotos" name="fotos" class="file-upload-input" multiple>
                        <label for="fotos" class="file-upload-label">
                            <i class="fas fa-camera"></i>
                            <span class="file-upload-text">
                                <strong>Clique para adicionar fotos</strong><br>
                                ou arraste e solte aqui
                            </span>
                        </label>
                    </div>
                    <div class="file-preview" id="file-preview"></div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-check-circle"></i> Registrar Inspeção
                </button>
            </form>
        </div>
    </main>

    <!-- QR Code Scanner Modal -->
    <div id="scanner-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Escanear QR Code</h3>
                <button class="modal-close" onclick="fecharLeitorQRCode()">&times;</button>
            </div>
            <div class="scanner-container">
                <video id="scanner-video" class="scanner-video"></video>
                <p class="scanner-message" id="scanner-message">Posicione o código QR dentro da área de leitura</p>
                <button type="button" class="select-btn" onclick="fecharLeitorQRCode()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Equipment Selection Modal -->
    <div id="modalEquipamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Selecionar Equipamento</h3>
                <button class="modal-close" onclick="fecharModal('modalEquipamento')">&times;</button>
            </div>
            <input type="text" id="modalEquipamentoSearch" class="modal-search" 
                   placeholder="Pesquisar por tag ou localização..." oninput="filtrarEquipamentos()">
            <table id="modalEquipamentoTable" class="modal-table">
                <thead>
                    <tr>
                        <th>Tag</th>
                        <th>Tipo</th> 
                        <th>Classe</th>                                                
                        <th>Localização</th>                    
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Equipment data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
     
    <!-- Responsible Selection Modal -->
    <div id="modalResponsavel" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Selecionar Responsável</h3>
                <button class="modal-close" onclick="fecharModal('modalResponsavel')">&times;</button>
            </div>
            <input type="text" id="modalResponsavelSearch" class="modal-search" 
                   placeholder="Pesquisar por nome ou matrícula..." oninput="filtrarResponsaveis()">
            <table id="modalResponsavelTable" class="modal-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Matrícula</th>
                        <th>Setor</th>
                        <th>Nível de Acesso</th>                        
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Responsible data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Existing Records Modal -->
    <div id="modalRegistrosExistentes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Registros de Inspeções Existentes</h3>
                <button class="modal-close" onclick="fecharModalRegistrosExistentes()">&times;</button>
            </div>
            <p>Últimos 15 registros:</p>
            <input type="text" id="filtroRegistros" class="modal-search" 
                   placeholder="Pesquisar Tipo ou Localização..." oninput="filtrarRegistros()">
            <table id="tabelaRegistrosExistentes" class="modal-table">
                <thead>
                    <tr>
                        <th>Número</th>                       
                        <th>Tipo</th>
                        <th>Classe</th>                        
                        <th>Localização</th>
                        <th>Data Inspeção</th>
                        <th>Data Validade</th>
                        <th>Pendências</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Records data will be inserted here by JavaScript -->
                </tbody>
            </table>
            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="select-btn" onclick="escolherOpcao('sobrescrever')">
                    <i class="fas fa-sync-alt"></i> Sobrescrever Todos
                </button>
                <button type="button" class="select-btn" onclick="escolherOpcao('cancelar')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="select-btn" onclick="escolherOpcao('ignorar')">
                    <i class="fas fa-forward"></i> Ignorar
                </button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="user-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" hidden>
        <div class="modal-content">
            <button class="close" onclick="toggleModal()" aria-label="Fechar modal">&times;</button>
            <h2 id="modal-title">Perfil do Usuário</h2>
            <div class="profile-pic-container">
                <img id="modal-profile-pic" src="{{ url_for('static', filename=current_user.foto_perfil) if current_user.foto_perfil else 'https://cdn-icons-png.flaticon.com/128/1077/1077012.png' }}" alt="Foto de Perfil do usuário {{ current_user.nome }}">
                <button id="change-profile-pic" class="btn-secondary wave-effect" aria-label="Alterar foto de perfil">
                    <i class="fas fa-camera" style="margin-right: 0.5rem;"></i> Alterar Foto
                </button>
            </div>
            <div class="user-details">
                <p><strong><i class="fas fa-user" style="margin-right: 0.5rem;"></i> Nome:</strong> <span id="modal-user-name">{{ current_user.nome }}</span></p>
                <p><strong><i class="fas fa-envelope" style="margin-right: 0.5rem;"></i> Email:</strong> <span id="modal-user-email">{{ current_user.email }}</span></p>
                <p><strong><i class="fas fa-id-card" style="margin-right: 0.5rem;"></i> Matrícula:</strong> <span id="modal-user-matricula">{{ current_user.matricula }}</span></p>
                <p><strong><i class="fas fa-building" style="margin-right: 0.5rem;"></i> Setor:</strong> <span id="modal-user-setor">{{ current_user.setor }}</span></p>  
                <p><strong><i class="fas fa-user-tag" style="margin-right: 0.5rem;"></i> Usuário:</strong> <span id="modal-user-username">{{ current_user.usuario }}</span></p>              
                <p><strong><i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i> Nível de Acesso:</strong> <span id="modal-user-access" class="badge badge-primary">{{ current_user.nivel_acesso }}</span></p>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="loading" style="display:none;">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>

    <!-- Adicione este elemento antes do botão de submit -->
    <div id="location-status" class="alert alert-info" style="display: none;">
        <i class="fas fa-map-marker-alt"></i>
        <span id="location-text">Localização será registrada com sua inspeção</span>
    </div>

    <div id="crop-modal" style="display: none;">
        <div id="crop-container">
            <img id="crop-image" />
        </div>
    </div>

    <script>
        let lastLocationData = null;
       
        document.addEventListener('DOMContentLoaded', async function () {
            const tipoEquipamento = document.getElementById('tipo_equipamento');
            const classeEquipamentoGroup = document.getElementById('classe_equipamento_group');
            const checklistContainer = document.getElementById('checklist-container');

            // 1. Função para gerenciar a visibilidade do campo Classe
            function toggleClasseField() {
                const isExtintor = tipoEquipamento.value === 'Extintor';
                classeEquipamentoGroup.style.display = isExtintor ? 'block' : 'none';
                
                // Atualiza a obrigatoriedade do campo
                const classeInput = document.getElementById('classe_equipamento');
                if (classeInput) {
                    classeInput.required = isExtintor;
                }
            }

            // 3. Configuração inicial
            function setupInitialState() {
                // Configura o campo Tipo
                if (tipoEquipamento.value) {
                    toggleClasseField();
                }
                
                // Adiciona event listeners - MODIFICADO PARA CARREGAR CHECKLIST
                tipoEquipamento.addEventListener('change', async function() {
                    toggleClasseField();
                    const tipoId = document.getElementById('tipo_equipamento_id').value;
                    if (tipoId) {
                        await renderizarChecklist(tipoId);
                    }
                    await verificarStatusChecklist();
                });

                // Delegation para os itens de checklist (funciona para itens dinâmicos)
                checklistContainer.addEventListener('click', function(e) {
                    const item = e.target.closest('.inspection-item');
                    if (item) {
                        item.classList.toggle('checked');
                        const itemName = item.getAttribute('data-item');
                        const isChecked = item.classList.contains('checked');
                        updateInspectionForm(itemName, isChecked);
                        
                        // Feedback visual para itens obrigatórios
                        if (item.getAttribute('data-obrigatorio') === 'true') {
                            item.style.borderLeft = isChecked ? '3px solid var(--success-color)' 
                                                            : '3px solid var(--danger-color)';
                        }
                    }
                });
            }

            // 4. Inicialização
            try {
                setupInitialState();
                
                // Se já houver um tipo selecionado (recarregamento de página)
                if (tipoEquipamento.value) {
                    const tipoId = document.getElementById('tipo_equipamento_id').value;
                    if (tipoId) {
                        await renderizarChecklist(tipoId);
                    }
                }
            } catch (error) {
                console.error('Erro na inicialização:', error);
                checklistContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Erro ao carregar checklist. Recarregue a página.
                    </div>
                `;
            }
        });

        // Mova a função updateInspectionForm para fora do DOMContentLoaded
        function updateInspectionForm(itemName, isChecked) {
            // Remove inputs existentes com o mesmo nome
            document.querySelectorAll(`input[name="inspecao[${itemName}]"]`).forEach(input => input.remove());
            
            // Cria novo campo oculto apenas se o item estiver marcado
            if (isChecked) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `inspecao[${itemName}]`;
                input.value = '1';
                document.getElementById('inspecaoForm').appendChild(input);
            }
            
            verificarStatusChecklist();
        }

        // Adicione esta função para verificar pendências ao selecionar equipamento
        async function verificarPendenciasEquipamento(equipamentoId) {
            try {
                const response = await fetch(`/api/inspecoes_pendentes/${equipamentoId}`);
                if (!response.ok) return;
                
                const data = await response.json();
                if (data.pendencias && data.pendencias.length > 0) {
                    showPendingItemsAlert(data.pendencias);
                }
            } catch (error) {
                console.error('Erro ao verificar pendências:', error);
            }
        }

        // Adicione esta função para mostrar o alerta de itens pendentes
        async function showPendingItemsAlert(itensPendentes) {
            if (itensPendentes && itensPendentes.length > 0) {
                const itensLista = itensPendentes.map(item => `• ${item}`).join('<br>');
                
                await Swal.fire({
                    title: 'Inspeção Pendente Encontrada',
                    html: `Durante a última inspeção, ficaram pendentes os itens:<br><br>${itensLista}`,
                    icon: 'warning',
                    confirmButtonText: 'Entendi',
                    background: 'var(--darker-bg)',
                    color: 'var(--text-light)',
                    confirmButtonColor: 'var(--primary-color)',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }

        async function carregarChecklist(tipoEquipamentoId) {
            try {
                if (!tipoEquipamentoId) {
                    throw new Error('ID do tipo de equipamento não fornecido');
                }

                const response = await fetch(`/api/checklist_tipo/${tipoEquipamentoId}`);
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                       
                if (!Array.isArray(data)) {
                    throw new Error('Resposta da API inválida - esperado array');
                }
                
                return data;
            } catch (error) {
                console.error('Erro ao carregar checklist:', error);
                throw error;
            }
        }

        // Função melhorada para renderizar o checklist
        async function renderizarChecklist(tipoEquipamentoId) {
            const checklistContainer = document.getElementById('checklist-container');
            
            try {
                checklistContainer.innerHTML = '<div class="loading-message">Carregando itens do checklist...</div>';
                
                if (!tipoEquipamentoId) {
                    checklistContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            O equipamento selecionado não está associado a um tipo válido
                        </div>
                    `;
                    return;
                }
                
                const response = await fetch(`/api/checklist_tipo/${tipoEquipamentoId}`);
                
                if (!response.ok) {
                    throw new Error(`Erro ao carregar checklist: ${response.statusText}`);
                }
                
                const itensChecklist = await response.json();
                
                if (!itensChecklist || itensChecklist.length === 0) {
                    checklistContainer.innerHTML = '<div class="no-checklist">Nenhum item de checklist cadastrado para este tipo de equipamento</div>';
                    return;
                }
                
                checklistContainer.innerHTML = '';
                
                // Ordena os itens pela ordem definida no banco
                itensChecklist.sort((a, b) => a.ordem - b.ordem);
                
                // Cria um container flexível para os itens
                const itemsContainer = document.createElement('div');
                itemsContainer.style.display = 'flex';
                itemsContainer.style.flexWrap = 'wrap';
                itemsContainer.style.gap = '10px';
                
                itensChecklist.forEach(item => {
                    const itemElement = criarItemChecklist(item);
                    itemsContainer.appendChild(itemElement);
                });
                
                checklistContainer.appendChild(itemsContainer);
                
            } catch (error) {
                console.error('Erro ao renderizar checklist:', error);
                checklistContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ${error.message || 'Erro ao carregar checklist'}
                    </div>
                `;
            }
        }

        function criarItemChecklist(item) {
            const div = document.createElement('div');
            div.className = 'inspection-item';
            div.setAttribute('data-item', item.nome_item);
            div.setAttribute('data-obrigatorio', item.obrigatorio);
            
            // Conteúdo do item
            const content = document.createElement('span');
            content.textContent = item.nome_item;
            
            // Adiciona ícone de obrigatório se necessário
            if (item.obrigatorio) {
                const icon = document.createElement('i');
                icon.className = 'fas fa-exclamation-circle obrigatorio-icon';
                icon.title = 'Item obrigatório';
                div.appendChild(icon);
            }
            
            div.appendChild(content);
            
            // Cria o ícone de check (sempre presente, visibilidade controlada por CSS)
            const checkIcon = document.createElement('i');
            checkIcon.className = 'fas fa-check check-icon';
            div.appendChild(checkIcon);
            
            return div;
        }

        async function updateFormFields(equipamento) {
            const checklistContainer = document.getElementById('checklist-container'); // Definindo a variável aqui
            
            try {
                // Mostra loading durante o processamento
                const loadingSwal = Swal.fire({
                    title: 'Carregando...',
                    html: 'Preparando formulário e checklist',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    background: 'var(--darker-bg)',
                    color: 'var(--text-light)'
                });

                // Preenche os campos básicos
                document.getElementById('equipamento_id').value = equipamento.id;
                document.getElementById('equipamento_codigo_barras').value = equipamento.codigo_barras || '';
                document.getElementById('tipo_equipamento').value = equipamento.tipo;
                
                // Verifica se há erro na resposta da API
                if (equipamento.error) {
                    console.error(equipamento.error);
                    checklistContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${equipamento.error}
                        </div>
                    `;
                    document.getElementById('tipo_equipamento_id').value = '';
                    loadingSwal.close();
                    return;
                }
                
                document.getElementById('tipo_equipamento_id').value = equipamento.tipo_id || '';
                document.getElementById('classe_equipamento').value = equipamento.classe || '';
                document.getElementById('localizacao_equipamento').value = equipamento.localizacao;
                document.getElementById('status_equipamento').value = equipamento.status;

                // Carrega o checklist apenas se tiver tipo_id
                if (equipamento.tipo_id) {
                    await renderizarChecklist(equipamento.tipo_id);
                } else {
                    console.error('Tipo de equipamento não encontrado ou sem ID');
                    checklistContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Tipo de equipamento não configurado corretamente no sistema
                        </div>
                    `;
                }

                // Verifica se há pendências para este equipamento
                await verificarPendenciasEquipamento(equipamento.id);

                // Fecha o loading
                loadingSwal.close();

            } catch (error) {
                console.error('Erro ao atualizar campos:', error);
                Swal.fire({
                    title: 'Erro',
                    text: 'Não foi possível carregar as informações completas do equipamento.',
                    icon: 'error'
                });
                throw error;
            }
        }

        // Modifique a função verificarStatusChecklist para verificar todos os itens
        async function verificarStatusChecklist() {
            const tipoEquipamentoId = document.getElementById('tipo_equipamento_id').value;
            const statusInspecao = document.getElementById('status_inspecao');
            const motivo = document.getElementById('motivo');

            if (!tipoEquipamentoId) {
                statusInspecao.value = "Pendente";
                motivo.value = "Tipo de equipamento não selecionado";
                return;
            }

            try {
                const response = await fetch(`/api/checklist_tipo/${tipoEquipamentoId}`);
                const itensChecklist = await response.json();

                if (!Array.isArray(itensChecklist) || itensChecklist.length === 0) {
                    statusInspecao.value = "Finalizada";
                    motivo.value = "Checklist não possui itens cadastrados";
                    return;
                }

                const itensPendentes = [];

                for (const item of itensChecklist) {
                    const itemElement = document.querySelector(`.inspection-item[data-item="${item.nome_item}"]`);
                    if (!itemElement || !itemElement.classList.contains('checked')) {
                        itensPendentes.push(item.nome_item);
                    }
                }

                if (itensPendentes.length === 0) {
                    statusInspecao.value = "Finalizada";
                    motivo.value = "Todos os itens do checklist foram verificados.";
                } else {
                    statusInspecao.value = "Pendente";
                    if (itensPendentes.length > 3) {
                        motivo.value = `${itensPendentes.length} itens pendentes (ex: ${itensPendentes.slice(0, 3).join(', ')}...)`;
                    } else {
                        motivo.value = `Itens pendentes: ${itensPendentes.join(', ')}`;
                    }
                }

            } catch (error) {
                console.error('Erro ao verificar status do checklist:', error);
                statusInspecao.value = "Pendente";
                motivo.value = "Erro ao verificar checklist";
            }
        }

        // Adiciona o evento de mudança para o tipo de equipamento
        document.getElementById('tipo_equipamento').addEventListener('change', function() {
            verificarStatusChecklist();
        });

        // Função melhorada para gerar número de inspeção
        async function gerarNumeroInspecao() {
            try {
                // Verifica se já existe um número gerado
                const numeroExistente = document.getElementById('numero_inspecao').value;
                if (numeroExistente) {
                    return numeroExistente;
                }

                const response = await fetch('/api/gerar_numero_inspecao', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.numero_inspecao) {
                    throw new Error('Resposta da API não contém número de inspeção');
                }

                document.getElementById('numero_inspecao').value = data.numero_inspecao;
                return data.numero_inspecao;
                
            } catch (error) {
                console.error('Erro ao gerar número de inspeção:', error);
                
                // Tenta gerar um número local como fallback
                const fallbackNumber = 'INS-' + Date.now();
                document.getElementById('numero_inspecao').value = fallbackNumber;
                console.warn(`Usando número de fallback: ${fallbackNumber}`);
                
                return fallbackNumber;
            }
        }

        // Função de validação completa e otimizada
        async function validateInspectionForm() {
            // Lista de campos obrigatórios
            const requiredFields = [
                {id: 'equipamento_codigo_barras', message: 'Por favor, selecione ou escaneie o equipamento.'},
                {id: 'tipo_equipamento', message: 'Tipo de equipamento não identificado.'},
                {id: 'localizacao_equipamento', message: 'Localização do equipamento não identificada.'},
                {id: 'status_equipamento', message: 'Status do equipamento não identificado.'},
                {id: 'responsavel', message: 'Responsável pela inspeção não identificado.'},
                {id: 'observacoes', message: 'Por favor, insira uma descrição/observação sobre a inspeção.'}
            ];

            // Valida campos obrigatórios
            for (const field of requiredFields) {
                const input = document.getElementById(field.id);
                if (!input || !input.value.trim()) {
                    input.style.borderColor = 'red';
                    await showAlert('Atenção', field.message, 'warning');
                    input.focus();
                    return false;
                }
                input.style.borderColor = '';
            }

            // Valida checklist
            const checkedItems = document.querySelectorAll('.inspection-item.checked');
            if (checkedItems.length === 0) {
                await showAlert('Atenção', 'Por favor, marque pelo menos um item do checklist.', 'warning');
                return false;
            }

            // Valida itens obrigatórios do checklist
            const tipoEquipamentoId = document.getElementById('tipo_equipamento_id').value;
            if (tipoEquipamentoId) {
                try {
                    const response = await fetch(`/api/checklist_tipo/${tipoEquipamentoId}`);
                    const itensChecklist = await response.json();
                    
                    // Filtra apenas os itens obrigatórios
                    const itensObrigatorios = itensChecklist.filter(item => item.obrigatorio);
                    
                    // Verifica se todos estão marcados
                    for (const item of itensObrigatorios) {
                        const itemElement = document.querySelector(`.inspection-item[data-item="${item.nome_item}"]`);
                        if (!itemElement || !itemElement.classList.contains('checked')) {
                            await showAlert('Atenção', `O item "${item.nome_item}" é obrigatório e não foi marcado.`, 'warning');
                            itemElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            itemElement.style.animation = 'pulse 1s 3';
                            return false;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao validar checklist:', error);
                }
            }

            // Valida fotos
            const fotosInput = document.getElementById('fotos');
            if (fotosInput.files.length === 0) {
                await showAlert('Atenção', 'Por favor, anexe pelo menos uma foto da inspeção.', 'warning');
                return false;
            }

            return true;
        }

        // Função para preparar os dados do formulário - VERSÃO CORRIGIDA
        async function prepareFormData() {
            const form = document.getElementById('inspecaoForm');
            const formData = new FormData(form);
            
            // Verifica e atualiza o status do checklist antes de enviar
            verificarStatusChecklist();
            
            // Restante do código permanece o mesmo...
            let numeroInspecao = formData.get('numero_inspecao');
            
            if (!numeroInspecao) {
                numeroInspecao = await gerarNumeroInspecao();
                formData.set('numero_inspecao', numeroInspecao);
            }
            
            formData.set('numero_inspecao', numeroInspecao);
            
            // Adiciona status_inspecao e motivo ao FormData
            formData.set('status_inspecao', document.getElementById('status_inspecao').value);
            formData.set('motivo', document.getElementById('motivo').value);
            
            // Adiciona checklist ao FormData
            const checklistItems = document.querySelectorAll('.inspection-item');
            checklistItems.forEach(item => {
                const itemName = item.getAttribute('data-item');
                const isChecked = item.classList.contains('checked');
                formData.set(`inspecao_${itemName}`, isChecked ? '1' : '0');
            });
            
            return formData;
        }

        // Função para mostrar loading durante o processamento
        function showLoading() {
            return Swal.fire({
                title: 'Processando...',
                html: 'Estamos registrando sua inspeção',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                },
                background: 'var(--darker-bg)',
                color: 'var(--text-light)'
            });
        }

        // Modifique a função getLocation para armazenar os dados
        async function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    console.warn('Geolocalização não suportada');
                    reject('Geolocalização não é suportada pelo seu navegador');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('Localização obtida com sucesso:', position);
                        lastLocationData = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: position.timestamp
                        };
                        resolve(lastLocationData);
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Usuário negou a solicitação de geolocalização.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Informações de localização não estão disponíveis.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "A solicitação de localização expirou.";
                                break;
                            default:
                                errorMessage = "Ocorreu um erro desconhecido ao obter a localização.";
                        }
                        reject(errorMessage);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        document.getElementById('inspecaoForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const form = this;
            const locationCheckbox = document.getElementById('compartilharLocalizacao');

            if (submitBtn.getAttribute('data-submitting') === 'true') return;
            submitBtn.setAttribute('data-submitting', 'true');
            submitBtn.disabled = true;

            try {
                let locationData = null;
                let locationError = null;

                if (locationCheckbox.checked) {
                    try {
                        console.log('Obtendo localização...');
                        locationData = await getLocation();
                        console.log('Localização obtida:', locationData);

                        // Adiciona metadados detalhados
                        locationData.device_info = {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            resolution: `${window.screen.width}x${window.screen.height}`,
                            deviceMemory: navigator.deviceMemory || 'unknown',
                            connection: navigator.connection ? {
                                type: navigator.connection.type,
                                effectiveType: navigator.connection.effectiveType,
                                downlink: navigator.connection.downlink
                            } : 'unknown'
                        };

                        const locationInput = document.createElement('input');
                        locationInput.type = 'hidden';
                        locationInput.name = 'localizacao';
                        locationInput.value = JSON.stringify(locationData);
                        form.appendChild(locationInput);
                    } catch (error) {
                        console.warn('Falha ao obter localização:', error);
                        locationError = error;
                        
                        const confirm = await Swal.fire({
                            title: 'Localização Não Disponível',
                            html: `<div class="location-alert">
                                    <i class="fas fa-map-marker-alt-slash"></i>
                                    <div>
                                        <p>${error.message}</p>
                                        <small class="text-muted">Deseja continuar sem registrar a localização?</small>
                                    </div>
                                </div>`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Continuar Sem Localização',
                            cancelButtonText: 'Tentar Novamente',
                            background: 'var(--darker-bg)',
                            color: 'var(--text-light)',
                            customClass: {
                                confirmButton: 'btn btn-primary',
                                cancelButton: 'btn btn-secondary'
                            }
                        });

                        if (!confirm.isConfirmed) {
                            submitBtn.disabled = false;
                            submitBtn.removeAttribute('data-submitting');
                            return;
                        }
                    }
                } else {
                    // Usuário optou por não compartilhar localização
                    const confirm = await Swal.fire({
                        title: 'Localização Desativada',
                        html: `<div class="location-alert">
                                <i class="fas fa-map-marker-slash"></i>
                                <div>
                                    <p>Você optou por não compartilhar sua localização.</p>
                                    <small class="text-muted">Isso afetará o rastreamento geográfico desta inspeção.</small>
                                </div>
                            </div>`,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'Continuar Assim',
                        cancelButtonText: 'Ativar Localização',
                        background: 'var(--darker-bg)',
                        color: 'var(--text-light)'
                    });

                    if (!confirm.isConfirmed) {
                        locationCheckbox.checked = true;
                        submitBtn.disabled = false;
                        submitBtn.removeAttribute('data-submitting');
                        return;
                    }
                }

                if (!await validateInspectionForm()) {
                    submitBtn.disabled = false;
                    submitBtn.removeAttribute('data-submitting');
                    return;
                }

                const loadingSwal = showLoading();
                const formData = await prepareFormData();

                const response = await fetch('/inspecoes/nova_inspecao', {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                await loadingSwal.close();

                if (data.registros_existente) {

                    // Adiciona dados de localização ao modal se existirem
                    if (locationData) {
                        data.registros_existente.forEach(registro => {
                            registro.localizacao_data = locationData;
                        });
                    }
                    
                    abrirModalRegistrosExistentes(data.registros_existente);
                } else if (data.success) {
                    let message = data.message;
                    
                    await showAlert('Sucesso!', message, 'success');
                    limparFormulario();
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro no envio do formulário:', error);
                await Swal.close();
                
                let errorMessage = error.message;
                if (error instanceof TypeError) {
                    errorMessage = 'Erro de conexão. Verifique sua rede e tente novamente.';
                }
                
                await showAlert('Erro', errorMessage, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.removeAttribute('data-submitting');
                
                // Remove inputs de localização temporários
                document.querySelectorAll('input[name="localizacao"]').forEach(input => input.remove());
            }
        });

        // Atualize a função escolherOpcao
        async function escolherOpcao(opcao) {
            const submitBtn = document.getElementById('submitBtn');
            const form = document.getElementById('inspecaoForm');
            const locationCheckbox = document.getElementById('compartilharLocalizacao');
            
            try {
                fecharModalRegistrosExistentes();

                if (!await validateInspectionForm()) {
                    submitBtn.disabled = false;
                    submitBtn.removeAttribute('data-submitting');
                    return;
                }

                // Verifica se a localização está ativada
                if (locationCheckbox.checked) {
                    // Se já temos dados de localização, usa-os
                    if (lastLocationData) {
                        const locationInput = document.createElement('input');
                        locationInput.type = 'hidden';
                        locationInput.name = 'localizacao';
                        locationInput.value = JSON.stringify({
                            ...lastLocationData,
                            device_info: {
                                userAgent: navigator.userAgent,
                                platform: navigator.platform,
                                resolution: `${window.screen.width}x${window.screen.height}`
                            }
                        });
                        form.appendChild(locationInput);
                    } else {
                        // Se não tem dados, tenta obter novamente
                        try {
                            const locationData = await getLocation();
                            const locationInput = document.createElement('input');
                            locationInput.type = 'hidden';
                            locationInput.name = 'localizacao';
                            locationInput.value = JSON.stringify({
                                ...locationData,
                                device_info: {
                                    userAgent: navigator.userAgent,
                                    platform: navigator.platform,
                                    resolution: `${window.screen.width}x${window.screen.height}`
                                }
                            });
                            form.appendChild(locationInput);
                        } catch (error) {
                            console.warn('Falha ao obter localização:', error);
                            const confirm = await Swal.fire({
                                title: 'Localização Não Obtida',
                                html: `<div class="location-alert">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <div>
                                            <p>${error}</p>
                                            <small class="text-muted">Deseja continuar sem a localização?</small>
                                        </div>
                                    </div>`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Continuar Sem Localização',
                                cancelButtonText: 'Cancelar',
                                background: 'var(--darker-bg)',
                                color: 'var(--text-light)'
                            });

                            if (!confirm.isConfirmed) {
                                submitBtn.disabled = false;
                                submitBtn.removeAttribute('data-submitting');
                                return;
                            }
                        }
                    }
                }

                const loadingSwal = Swal.fire({
                    title: 'Processando...',
                    html: 'Estamos registrando sua inspeção',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); },
                    background: 'var(--darker-bg)',
                    color: 'var(--text-light)'
                });

                const formData = new FormData(form);
                formData.append('acao', opcao);

                const checklistItems = document.querySelectorAll('.inspection-item');
                checklistItems.forEach(item => {
                    const itemName = item.getAttribute('data-item');
                    const isChecked = item.classList.contains('checked');
                    formData.append(`inspecao[${itemName}]`, isChecked ? '1' : '0');
                });

                const response = await fetch('/inspecoes/acao', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                Swal.close();

                if (data.success) {
                    let message = data.message;
                    if (data.localizacao_salva) {
                        message += '<div class="mt-2"><i class="fas fa-map-marker-alt text-success"></i> Localização registrada</div>';
                    } else {
                        message += '<div class="mt-2"><i class="fas fa-map-marker-slash text-warning"></i> Localização não registrada</div>';
                    }
                    
                    await Swal.fire({
                        title: 'Sucesso!',
                        html: message,
                        icon: 'success',
                        customClass: {
                            htmlContainer: 'text-left'
                        }
                    });
                    
                    if (opcao === 'sobrescrever' || opcao === 'ignorar') {
                        setTimeout(() => { window.location.reload(); }, 1500);
                    }
                } else {
                    throw new Error(data.error || 'Erro desconhecido ao processar a ação');
                }
            } catch (error) {
                console.error('Erro em escolherOpcao:', error);
                Swal.close();
                
                await Swal.fire({
                    title: 'Erro',
                    text: error.message || 'Ocorreu um erro ao processar sua solicitação.',
                    icon: 'error'
                });
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.removeAttribute('data-submitting');
                }
            }            
        }

        // Função de limpeza do formulário melhorada
        function limparFormulario() {
            // Mantém os campos do equipamento e responsável
            const equipamentoCodigo = document.getElementById('equipamento_codigo_barras').value;
            const responsavel = document.getElementById('responsavel').value;
            
            // Reseta o formulário
            document.getElementById('inspecaoForm').reset();
            
            // Restaura valores importantes
            document.getElementById('equipamento_codigo_barras').value = equipamentoCodigo;
            document.getElementById('responsavel').value = responsavel;
            
            // Limpa o checklist
            // Atualiza a função que lida com os itens do checklist
            document.querySelectorAll('.inspection-item').forEach(item => {
                item.addEventListener('click', function() {
                    this.classList.toggle('checked');
                    const itemName = this.getAttribute('data-item');
                    updateInspectionForm(itemName, this.classList.contains('checked'));
                    verificarStatusChecklist();
                });
            });
                        
            // Limpa preview de fotos
            document.getElementById('file-preview').innerHTML = '';
            
            // Remove inputs de checklist ocultos
            document.querySelectorAll('input[name^="inspecao["]').forEach(input => {
                input.remove();
            });
        }

        // Função para abrir o modal
        function toggleModal() {
            const modal = document.getElementById('user-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }        // Função para alterar a foto de perfil

        let cropper = null;

        document.getElementById('change-profile-pic').addEventListener('click', function () {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    const image = document.createElement('img');
                    image.src = e.target.result;
                    image.style = 'max-width: 100%; max-height: 400px;';
                    image.id = 'cropper-img';

                    const cropContainer = document.createElement('div');
                    cropContainer.appendChild(image);

                    Swal.fire({
                        title: 'Corte sua imagem',
                        html: cropContainer,
                        showCancelButton: true,
                        confirmButtonText: 'Salvar',
                        background: 'var(--darker-bg)',
                        color: 'var(--text-light)',
                        customClass: {
                            popup: 'rounded-xl p-2',
                            confirmButton: 'bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700',
                            cancelButton: 'bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700'
                        },
                        didOpen: () => {
                            cropper = new Cropper(image, {
                                aspectRatio: 1,
                                viewMode: 1,
                                background: false,
                                autoCropArea: 1,
                                movable: true,
                                zoomable: true,
                                responsive: true
                            });
                        },
                        preConfirm: () => {
                            return new Promise((resolve, reject) => {
                                if (!cropper) {
                                    reject('Cropper não inicializado.');
                                    return;
                                }

                                const canvas = cropper.getCroppedCanvas({
                                    width: 300,
                                    height: 300
                                });

                                if (!canvas) {
                                    reject('Erro ao gerar canvas.');
                                    return;
                                }

                                canvas.toBlob(async (blob) => {
                                    if (!blob) {
                                        reject('Erro ao gerar imagem.');
                                        return;
                                    }

                                    Swal.close(); // Fecha o modal de corte
                                    await new Promise(r => setTimeout(r, 300)); // Aguarda transição

                                    Swal.fire({
                                        title: 'Processando...',
                                        html: 'Atualizando sua foto de perfil',
                                        allowOutsideClick: false,
                                        didOpen: () => Swal.showLoading(),
                                        background: 'var(--darker-bg)',
                                        color: 'var(--text-light)'
                                    });

                                    const formData = new FormData();
                                    formData.append('foto_perfil', blob, 'perfil.jpg');

                                    try {
                                        const response = await fetch('/api/alterar_foto_perfil', {
                                            method: 'POST',
                                            body: formData
                                        });

                                        const data = await response.json();
                                        Swal.close();

                                        if (data.success) {
                                            const imgURL = data.foto_perfil_url + `?v=${Date.now()}`;
                                            document.querySelectorAll('.user-avatar, #modal-profile-pic').forEach(img => {
                                                img.src = imgURL;
                                            });
                                            setTimeout(() => {
                                                location.reload();
                                            }, 1000);
                                            await showAlert('Sucesso!', 'Foto de perfil atualizada com sucesso!', 'success');
                                        } else {
                                            await showAlert('Erro', data.error || 'Erro ao atualizar a foto de perfil.', 'error');
                                        }
                                    } catch (err) {
                                        Swal.close();
                                        console.error(err);
                                        await showAlert('Erro', data.error || 'Erro ao atualizar a foto de perfil.', 'error');
                                    }

                                    resolve();
                                }, 'image/jpeg');
                            });
                        },
                        willClose: () => {
                            if (cropper) {
                                cropper.destroy();
                                cropper = null;
                            }
                        }
                    });
                };

                reader.readAsDataURL(file);
            });

            input.click();
        });

        // Funções de manipulação de modal
        function abrirModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function abrirModalResponsavel() {
            abrirModal('modalResponsavel');
            if (!responsaveisCarregados) {
                carregarResponsaveis();
                responsaveisCarregados = true;
            }
        }

        function abrirModalEquipamento() {
            abrirModal('modalEquipamento');
            if (!equipamentosCarregados) {
                carregarEquipamentos();
                equipamentosCarregados = true;
            }
        }

        async function abrirModalRegistrosExistentes(registros) {
            const modal = document.getElementById('modalRegistrosExistentes');
            const tbody = document.querySelector('#tabelaRegistrosExistentes tbody');
            tbody.innerHTML = '';

            registros.forEach(registro => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${registro.numero_inspecao}</td>               
                    <td>${registro.tipo}</td>
                    <td>${registro.classe}</td>
                    <td>${registro.localizacao}</td>
                    <td>${registro.data_inspecao || 'N/A'}</td>
                    <td>${registro.data_validade_inspecao || 'N/A'}</td>
                    <td>—</td>
                `;

                tbody.appendChild(row);
            });

            modal.style.display = 'block';
        }

        // Função para fechar o modal
        function fecharModalRegistrosExistentes() {
            const modal = document.getElementById('modalRegistrosExistentes');
            modal.style.display = 'none';
        }

        // Função para filtrar registros na tabela
        function filtrarRegistros() {
            const filtro = document.getElementById('filtroRegistros').value.toLowerCase();
            const linhas = document.querySelectorAll('#tabelaRegistrosExistentes tbody tr');

            linhas.forEach(linha => {
                const textoLinha = linha.textContent.toLowerCase();
                if (textoLinha.includes(filtro)) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        }

        // Funções para carregar dados
        async function carregarResponsaveis() {
            try {
                const response = await fetch('/api/usuarios');
                const usuarios = await response.json();
                preencherTabelaResponsaveis(usuarios);
            } catch (error) {
                console.error('Erro ao carregar usuarios:', error);
            }
        }

        async function carregarEquipamentos() {
            try {
                const response = await fetch('/api/selecao_equipamentos');
                const equipamentos = await response.json();
                preencherTabelaEquipamentos(equipamentos);
            } catch (error) {
                console.error('Erro ao carregar equipamentos:', error);
            }
        }

        // Funções para preencher tabelas
        function preencherTabelaResponsaveis(usuarios) {
            const tbody = document.getElementById('modalResponsavelTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            usuarios.forEach(usuario => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = usuario.nome;
                row.insertCell(1).textContent = usuario.matricula;
                row.insertCell(2).textContent = usuario.setor;
                row.insertCell(3).textContent = usuario.nivel_acesso;
                const selectCell = row.insertCell(4);
                const selectButton = document.createElement('button');
                selectButton.textContent = 'Selecionar';
                selectButton.className = 'select-btn';
                selectButton.onclick = function() {
                    document.getElementById('responsavel').value = usuario.nome;
                    fecharModal('modalResponsavel');
                };
                selectCell.appendChild(selectButton);

                // Adiciona data-label para dispositivos móveis
                row.cells[0].setAttribute('data-label', 'Nome');
                row.cells[1].setAttribute('data-label', 'Matrícula');
                row.cells[2].setAttribute('data-label', 'Setor');
                row.cells[3].setAttribute('data-label', 'Nível de Acesso');
                row.cells[4].setAttribute('data-label', 'Ação');
            });
        }

        function preencherTabelaEquipamentos(equipamentos) {
            const tbody = document.getElementById('modalEquipamentoTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            equipamentos.forEach(equipamento => {
                const row = tbody.insertRow();
                
                // Células com os dados do equipamento
                row.insertCell(0).textContent = equipamento.tag_equipamento || 'N/A';
                row.insertCell(1).textContent = equipamento.tipo || 'N/A';
                row.insertCell(2).textContent = equipamento.classe || 'N/A';
                row.insertCell(3).textContent = equipamento.localizacao || 'N/A';
                
                // Célula com botão de ação
                const selectCell = row.insertCell(4);
                const selectButton = document.createElement('button');
                selectButton.textContent = 'Selecionar';
                selectButton.className = 'select-btn';

                // Evento de clique com validação
                selectButton.onclick = async function () {
                    try {
                        if (!equipamento.codigo_barras || !equipamento.tipo) {
                            Swal.fire({
                                title: 'Dados incompletos',
                                text: 'Este equipamento não possui um tipo cadastrado. Verifique o cadastro.',
                                icon: 'warning'
                            });
                            return;
                        }

                        selectButton.disabled = true;
                        selectButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';

                        const response = await fetch(`/api/equipamento/${equipamento.codigo_barras}`);
                        
                        if (!response.ok) {
                            if (response.status === 404) {
                                Swal.fire({
                                    title: 'Checklist não encontrado',
                                    text: 'Este tipo de equipamento ainda não possui checklist cadastrado.',
                                    icon: 'warning'
                                });
                            } else {
                                throw new Error('Erro ao buscar detalhes do equipamento');
                            }
                            return;
                        }

                        const equipamentoCompleto = await response.json();

                        document.getElementById('equipamento_codigo_barras').value = equipamentoCompleto.codigo_barras || '';

                        await updateFormFields(equipamentoCompleto);
                        fecharModal('modalEquipamento');

                    } catch (error) {
                        console.error('Erro ao selecionar equipamento:', error);
                        Swal.fire({
                            title: 'Erro',
                            text: 'Ocorreu um erro ao carregar o equipamento. Tente novamente.',
                            icon: 'error'
                        });
                    } finally {
                        selectButton.disabled = false;
                        selectButton.textContent = 'Selecionar';
                    }
                };


                selectCell.appendChild(selectButton);

                // Adiciona data-label para responsividade
                const labels = ['Tag', 'Tipo', 'Classe', 'Localização', 'Ação'];
                for (let i = 0; i < labels.length; i++) {
                    row.cells[i].setAttribute('data-label', labels[i]);
                }
            });
        }

        // Funções de filtro
        function filtrarResponsaveis() {
            const searchValue = document.getElementById('modalResponsavelSearch').value.toLowerCase();
            const rows = document.getElementById('modalResponsavelTable').getElementsByTagName('tbody')[0].rows;
            for (let row of rows) {
                const nome = row.cells[0].textContent.toLowerCase();
                const matricula = row.cells[1].textContent.toLowerCase();
                if (nome.includes(searchValue) || matricula.includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        function filtrarEquipamentos() {
            const searchValue = document.getElementById('modalEquipamentoSearch').value.toLowerCase();
            const rows = document.getElementById('modalEquipamentoTable').getElementsByTagName('tbody')[0].rows;
            for (let row of rows) {
                const tag = row.cells[0].textContent.toLowerCase();
                const localizacao = row.cells[1].textContent.toLowerCase();
                if (tag.includes(searchValue) || localizacao.includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Função auxiliar para mostrar mensagens bonitas
        function showAlert(title, text, icon, confirmButtonText = 'OK') {
            return Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonText: confirmButtonText,
                background: 'var(--darker-bg)',
                color: 'var(--text-light)',
                confirmButtonColor: 'var(--primary-color)'
            });
        }

        async function showResultModal(result) {
            if (result.success) {
                await showAlert('Sucesso!', result.message, 'success');
            } else {
                await showAlert('Erro', result.error || 'Ocorreu um erro', 'error');
            }
        }

        // Função para confirmar ações
        async function showConfirm(title, text, icon = 'question') {
            return Swal.fire({
                title: title,
                text: text,
                icon: icon,
                showCancelButton: true,
                confirmButtonColor: 'var(--primary-color)',
                cancelButtonColor: 'var(--danger-color)',
                confirmButtonText: 'Sim',
                cancelButtonText: 'Cancelar',
                background: 'var(--darker-bg)',
                color: 'var(--text-light)'
            }).then((result) => {
                return result.isConfirmed;
            });
        }

        // Variáveis de controle
        let responsaveisCarregados = false;
        let equipamentosCarregados = false;
        let isScanning = false;
        let codeReader = null;
        let scannerActive = false;

        // Função para abrir o leitor de QR Code e código de barras
        async function abrirLeitorQRCode() {
            const modal = document.getElementById('scanner-modal');
            const video = document.getElementById('scanner-video');
            const message = document.getElementById('scanner-message');
            
            modal.style.display = 'block';
            message.textContent = 'Posicione o código QR ou de barras dentro da área de leitura';
            
            try {
                // Inicializa o leitor apenas se não existir
                if (!codeReader) {
                    codeReader = new ZXing.BrowserMultiFormatReader();
                }
                
                // Limpa qualquer leitura anterior
                if (scannerActive) {
                    await codeReader.reset();
                    scannerActive = false;
                }
                
                // Inicia a leitura sem tentar selecionar câmera específica
                scannerActive = true;
                await codeReader.decodeFromVideoDevice(null, video, (result, err) => {
                    if (result && scannerActive) {
                        handleScannedCode(result.text);
                        
                        // Para a leitura após sucesso
                        scannerActive = false;
                        codeReader.reset();
                        modal.style.display = 'none';
                    }
                    
                    if (err) {
                        // Ignora erros de "não encontrado" (esperados durante a leitura)
                        if (!(err instanceof ZXing.NotFoundException)) {
                            console.error('Erro na leitura:', err);
                            message.textContent = 'Erro na leitura. Tente novamente.';
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao inicializar o scanner:', error);
                
                if (error.name === 'NotAllowedError') {
                    message.textContent = 'Permissão de câmera negada. Por favor, permita o acesso à câmera.';
                } else {
                    message.textContent = 'Erro ao acessar a câmera. Verifique as permissões.';
                }
                
                scannerActive = false;
            }
        }

        // Função para fechar o leitor de QR Code
        function fecharLeitorQRCode() {
            if (codeReader && scannerActive) {
                codeReader.reset();
                scannerActive = false;
            }
            document.getElementById('scanner-modal').style.display = 'none';
        }

        // Função para tratar o código escaneado
        async function handleScannedCode(code) {
            try {
                if (!code || code.trim() === '') {
                    throw new Error('Código vazio ou inválido');
                }

                Swal.fire({
                    title: 'Processando...',
                    html: 'Buscando informações do equipamento',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    background: 'var(--darker-bg)',
                    color: 'var(--text-light)'
                });

                // Busca os detalhes básicos do equipamento
                const response = await fetch(`/api/equipamento_por_codigo/${encodeURIComponent(code)}`);
                if (!response.ok) throw new Error('Equipamento não encontrado');

                const equipamento = await response.json();

                // Preenche os campos do formulário
                document.getElementById('equipamento_codigo_barras').value = equipamento.codigo_barras || code;
                document.getElementById('equipamento_id').value = equipamento.id;
                document.getElementById('tipo_equipamento').value = equipamento.tipo;
                document.getElementById('classe_equipamento').value = equipamento.classe || '';
                document.getElementById('localizacao_equipamento').value = equipamento.localizacao;
                document.getElementById('status_equipamento').value = equipamento.status;

                document.getElementById('tipo_equipamento').dispatchEvent(new Event('change'));

                // Agora já tenta carregar os detalhes completos e o checklist automaticamente
                const responseChecklist = await fetch(`/api/equipamento/${equipamento.codigo_barras}`);
                if (!responseChecklist.ok) {
                    if (responseChecklist.status === 404) {
                        Swal.fire({
                            title: 'Checklist não encontrado',
                            text: 'Este tipo de equipamento ainda não possui checklist cadastrado.',
                            icon: 'warning'
                        });
                    } else {
                        throw new Error('Erro ao buscar detalhes do equipamento');
                    }
                    return;
                }

                const equipamentoCompleto = await responseChecklist.json();
                await updateFormFields(equipamentoCompleto); // <-- Essa função carrega o checklist
                fecharModal('modalEquipamento');

                Swal.close();
                await showAlert('Sucesso!', 'Equipamento identificado com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao processar código escaneado:', error);
                Swal.close();

                // Tenta buscar o equipamento pelo código como ID
                try {
                    const response = await fetch(`/api/equipamento/${encodeURIComponent(code)}`);
                    if (response.ok) {
                        const equipamento = await response.json();
                        document.getElementById('equipamento_codigo_barras').value = equipamento.codigo_barras || code;
                        document.getElementById('equipamento_id').value = equipamento.id;
                        document.getElementById('tipo_equipamento').value = equipamento.tipo;
                        document.getElementById('classe_equipamento').value = equipamento.classe || '';
                        document.getElementById('localizacao_equipamento').value = equipamento.localizacao;
                        document.getElementById('status_equipamento').value = equipamento.status;

                        document.getElementById('tipo_equipamento').dispatchEvent(new Event('change'));

                        // Tenta também carregar o checklist
                        const checklistResponse = await fetch(`/api/equipamento/${equipamento.codigo_barras}`);
                        if (checklistResponse.ok) {
                            const equipamentoCompleto = await checklistResponse.json();
                            await updateFormFields(equipamentoCompleto);
                            fecharModal('modalEquipamento');
                        }

                        await showAlert('Sucesso!', 'Equipamento identificado pelo Código!', 'success');
                    } else {
                        throw new Error('Equipamento não encontrado');
                    }
                } catch (fallbackError) {
                    console.error('Erro no fallback de busca:', fallbackError);
                    document.getElementById('equipamento_codigo_barras').value = code;

                    await showAlert(
                        'Equipamento não encontrado', 
                        `O código "${code}" não corresponde a nenhum equipamento cadastrado. Por favor, selecione manualmente.`,
                        'error'
                    );

                    abrirModalEquipamento();
                }
            }
        }

        // File upload preview
        document.getElementById('fotos').addEventListener('change', function(e) {
            const preview = document.getElementById('file-preview');
            preview.innerHTML = '';
            
            for (const file of e.target.files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'file-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'file-preview-item-remove';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.addEventListener('click', function() {
                        previewItem.remove();
                        // Should also remove the file from the input
                    });
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    preview.appendChild(previewItem);
                }
                reader.readAsDataURL(file);
            }
        });

        // Adicione este evento para limpar o scanner quando o modal for fechado
        document.getElementById('scanner-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                fecharLeitorQRCode();
            }
        });

        // Função para buscar detalhes do equipamento
        async function fetchEquipamentoDetails(codigoBarras) {
            try {
                const response = await fetch(`/api/equipamento/${codigoBarras}`);
                if (!response.ok) {
                    throw new Error('Equipamento não encontrado');
                }
                
                const data = await response.json();
                updateFormFields(data);
            } catch (error) {
                await showAlert('Erro', error.message, 'error');
                clearEquipamentoFields();
            }
        }

        // Função para limpar os campos do equipamento
        function clearEquipamentoFields() {
            document.getElementById('equipamento_id').value = '';
            document.getElementById('tipo_equipamento').value = '';
            document.getElementById('classe_equipamento').value = '';
            document.getElementById('localizacao_equipamento').value = '';
            document.getElementById('status_equipamento').value = '';

            // Oculta todos os checklists
            Object.values(checklists).forEach(checklist => {
                if (checklist) checklist.style.display = 'none';
            });
        }

        // Função para exibir mensagens
        function showMessage(text, type) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            msgDiv.textContent = text;
            document.querySelector('.container').prepend(msgDiv);
            setTimeout(() => msgDiv.remove(), 5000);
        }

        // Event Listeners
        document.getElementById('equipamento_codigo_barras').addEventListener('change', function(e) {
            if (e.target.value) fetchEquipamentoDetails(e.target.value);
        });

        document.getElementById('logoutButton').addEventListener('click', async function(event) {
            const confirmed = await showConfirm('Confirmação', 'Você tem certeza que deseja fazer logoff?');
            
            if (confirmed) {
                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        await showAlert('Erro', 'Falha no logoff. Tente novamente.', 'error');
                    }
                } catch (error) {
                    console.error('Erro de rede:', error);
                    await showAlert('Erro', 'Erro de rede. Tente novamente.', 'error');
                }
            }
        });
        
        // Funções auxiliares
        function handleScanSuccess(code) {
            document.getElementById('equipamento_codigo_barras').value = code;
            fetchEquipamentoDetails(code);
            showMessage(`Código escaneado: ${code}`, 'success');
        }

        function navigateTo(page) {
            window.location.href = (`/${page}`);
        }

        function handleScanError(error) {
            console.error(error);
            showMessage("Erro ao escanear o código. Tente novamente.", 'error');
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        });

    </script>
</body>
</html> 